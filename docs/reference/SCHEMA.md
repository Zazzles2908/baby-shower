# Database Schema Reference - Baby Shower App

**Last Updated**: 2026-01-02  
**Version**: 1.0  
**Purpose**: Database schema details and SQL reference

---

## Table of Contents

1. [Schema Overview](#schema-overview)
2. [Table Definitions](#table-definitions)
3. [Activity Types](#activity-types)
4. [Indexes](#indexes)
5. [Views](#views)
6. [Triggers](#triggers)
7. [Permissions](#permissions)
8. [Migration Function](#migration-function)

---

## Schema Overview

The Baby Shower app uses a dual-schema design:

- **public schema** - Hot layer for real-time queries
- **internal schema** - Cold layer for immutable archive

---

## Table Definitions

### public.submissions

The main submissions table for all activity types:

```sql
CREATE TABLE IF NOT EXISTS public.submissions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    name TEXT NOT NULL,
    activity_type TEXT NOT NULL,
    activity_data JSONB DEFAULT '{}'::JSONB NOT NULL
);
```

**Columns**:

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BIGINT | PRIMARY KEY, IDENTITY | Auto-incrementing unique ID |
| `created_at` | TIMESTAMPTZ | NOT NULL | UTC timestamp of submission |
| `name` | TEXT | NOT NULL | Guest name (not activity-specific) |
| `activity_type` | TEXT | NOT NULL | Type of activity (guestbook, pool, quiz, advice, voting) |
| `activity_data` | JSONB | NOT NULL, DEFAULT '{}' | Activity-specific payload |

---

### internal.event_archive

Immutable archive table for backup and Google Sheets export:

```sql
CREATE TABLE IF NOT EXISTS internal.event_archive (
    id BIGINT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL,
    guest_name TEXT NOT NULL,
    activity_type TEXT NOT NULL,
    raw_data JSONB NOT NULL,
    processed_data JSONB NOT NULL,
    source_ip INET,
    user_agent TEXT,
    processing_time_ms INTEGER DEFAULT 0
);
```

**Columns**:

| Column | Type | Description |
|--------|------|-------------|
| `id` | BIGINT | Mirrors public.submissions.id |
| `created_at` | TIMESTAMPTZ | Mirrors public.submissions.created_at |
| `guest_name` | TEXT | Mirrors public.submissions.name |
| `activity_type` | TEXT | Mirrors public.submissions.activity_type |
| `raw_data` | JSONB | Original activity_data from submission |
| `processed_data` | JSONB | Enhanced with migration metadata |
| `source_ip` | INET | Client IP address (for audit) |
| `user_agent` | TEXT | Client user agent (for analytics) |
| `processing_time_ms` | INTEGER | Time taken to process trigger |

---

### internal.submission_stats

Statistics table for monitoring:

```sql
CREATE TABLE IF NOT EXISTS internal.submission_stats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    last_updated TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    total_submissions BIGINT DEFAULT 0,
    guestbook_count BIGINT DEFAULT 0,
    pool_count BIGINT DEFAULT 0,
    quiz_count BIGINT DEFAULT 0,
    advice_count BIGINT DEFAULT 0,
    voting_count BIGINT DEFAULT 0
);
```

---

## Activity Types

| activity_type | Description | Example Data |
|---------------|-------------|--------------|
| `guestbook` | Wish messages | `{"relationship": "Friend", "message": "Congrats!"}` |
| `baby_pool` | Birth predictions | `{"date_guess": "2026-03-15", "time_guess": "14:30", "weight_guess": 3.4, "length_guess": 51}` |
| `quiz` | Quiz answers | `{"puzzle1": "Baby Shower", "puzzle2": "...", "score": 5}` |
| `advice` | Advice messages | `{"advice_type": "For Parents", "message": "Sleep when baby sleeps!"}` |
| `voting` | Name votes | `{"names": ["Emma", "Olivia", "Sophia"]}` |

---

## Indexes

### Performance Indexes

```sql
-- Index on activity_type for filtering
CREATE INDEX IF NOT EXISTS idx_submissions_activity_type 
ON public.submissions(activity_type);

-- Index on created_at for sorting
CREATE INDEX IF NOT EXISTS idx_submissions_created_at 
ON public.submissions(created_at DESC);

-- Index on name for guest lookup
CREATE INDEX IF NOT EXISTS idx_submissions_name 
ON public.submissions(name);

-- Internal archive indexes
CREATE INDEX IF NOT EXISTS idx_internal_activity_type 
ON internal.event_archive(activity_type);

CREATE INDEX IF NOT EXISTS idx_internal_created_at 
ON internal.event_archive(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_internal_guest_name 
ON internal.event_archive(guest_name);

CREATE INDEX IF NOT EXISTS idx_internal_activity_date 
ON internal.event_archive(created_at, activity_type);
```

---

## Views

### Today's Submissions

```sql
CREATE OR REPLACE VIEW public.v_today_submissions AS
SELECT activity_type, COUNT(*) as count, MAX(created_at) as last_submission
FROM public.submissions
WHERE created_at >= CURRENT_DATE
GROUP BY activity_type;
```

### Activity Breakdown

```sql
CREATE OR REPLACE VIEW public.v_activity_breakdown AS
SELECT 
    activity_type,
    COUNT(*) as total_submissions,
    COUNT(DISTINCT name) as unique_guests,
    MIN(created_at) as first_submission,
    MAX(created_at) as last_submission
FROM public.submissions
GROUP BY activity_type;
```

### Vote Counts

```sql
CREATE OR REPLACE VIEW public.v_vote_counts AS
SELECT 
    jsonb_array_elements_text(activity_data->'names') as baby_name,
    COUNT(*) as vote_count
FROM public.submissions 
WHERE activity_type = 'voting'
GROUP BY baby_name
ORDER BY vote_count DESC;
```

### Pool Statistics

```sql
CREATE OR REPLACE VIEW public.v_pool_stats AS
SELECT 
    COUNT(*) as total_predictions,
    AVG((activity_data->>'weight_guess')::NUMERIC) as avg_weight,
    AVG((activity_data->>'length_guess')::NUMERIC) as avg_length,
    MIN(created_at) as first_prediction,
    MAX(created_at) as last_prediction
FROM public.submissions
WHERE activity_type = 'baby_pool';
```

---

## Triggers

### Migration Trigger

Fires after INSERT on public.submissions to copy data to internal schema:

```sql
CREATE OR REPLACE FUNCTION internal.handle_submission_migration()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO internal.event_archive (
        id, created_at, guest_name, activity_type, 
        raw_data, processed_data, source_ip, user_agent, processing_time_ms
    )
    VALUES (
        NEW.id, NEW.created_at, NEW.name, NEW.activity_type,
        NEW.activity_data, 
        NEW.activity_data || jsonb_build_object('migrated_at', NOW()::TEXT),
        NEW.source_ip, NEW.user_agent,
        EXTRACT(MILLISECONDS FROM (NOW() - NEW.created_at))::INTEGER
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_submission_insert
    AFTER INSERT ON public.submissions
    FOR EACH ROW
    EXECUTE FUNCTION internal.handle_submission_migration();
```

---

## Permissions

### Schema Permissions

```sql
-- Grant usage on schemas
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT USAGE ON SCHEMA internal TO service_role;
```

### Table Permissions

```sql
-- Public submissions table
GRANT SELECT, INSERT ON public.submissions TO anon, authenticated;
GRANT UPDATE, DELETE ON public.submissions TO service_role;

-- Internal archive table
GRANT SELECT ON internal.event_archive TO service_role;
GRANT INSERT ON internal.event_archive TO service_role;

-- Stats table
GRANT SELECT, UPDATE ON internal.submission_stats TO service_role;
```

### RLS Policies

```sql
-- Enable RLS
ALTER TABLE public.submissions ENABLE ROW LEVEL SECURITY;

-- Allow anonymous reads
CREATE POLICY "Allow anonymous reads" ON public.submissions
    FOR SELECT USING (true);

-- Allow anonymous inserts
CREATE POLICY "Allow anonymous inserts" ON public.submissions
    FOR INSERT WITH CHECK (true);

-- Deny updates and deletes
CREATE POLICY "Deny updates" ON public.submissions
    FOR UPDATE USING (false);

CREATE POLICY "Denies deletes" ON public.submissions
    FOR DELETE USING (false);
```

---

## Migration Function

### Function Definition

```sql
CREATE OR REPLACE FUNCTION internal.handle_submission_migration()
RETURNS TRIGGER AS $$
DECLARE
    start_time TIMESTAMPTZ;
    end_time TIMESTAMPTZ;
    process_time_ms INTEGER;
BEGIN
    start_time := clock_timestamp();
    
    -- Insert into internal archive
    INSERT INTO internal.event_archive (
        id, created_at, guest_name, activity_type,
        raw_data, processed_data, source_ip, user_agent
    )
    VALUES (
        NEW.id, NEW.created_at, NEW.name, NEW.activity_type,
        NEW.activity_data,
        NEW.activity_data || jsonb_build_object('migrated_at', NOW()::TEXT),
        NEW.source_ip, NEW.user_agent
    );
    
    end_time := clock_timestamp();
    process_time_ms := EXTRACT(MILLISECONDS FROM (end_time - start_time))::INTEGER;
    
    -- Update stats
    UPDATE internal.submission_stats
    SET 
        last_updated = NOW(),
        total_submissions = total_submissions + 1,
        guestbook_count = guestbook_count + CASE WHEN NEW.activity_type = 'guestbook' THEN 1 ELSE 0 END,
        pool_count = pool_count + CASE WHEN NEW.activity_type = 'baby_pool' THEN 1 ELSE 0 END,
        quiz_count = quiz_count + CASE WHEN NEW.activity_type = 'quiz' THEN 1 ELSE 0 END,
        advice_count = advice_count + CASE WHEN NEW.activity_type = 'advice' THEN 1 ELSE 0 END,
        voting_count = voting_count + CASE WHEN NEW.activity_type = 'voting' THEN 1 ELSE 0 END
    WHERE id = 1;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## Verification Queries

### Check Tables Exist

```sql
SELECT table_schema, table_name 
FROM information_schema.tables 
WHERE table_schema IN ('public', 'internal') 
ORDER BY table_schema, table_name;
```

### Check Columns

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'submissions' AND table_schema = 'public'
ORDER BY ordinal_position;
```

### Check Triggers

```sql
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers 
WHERE trigger_name = 'on_submission_insert';
```

### Check RLS Policies

```sql
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual
FROM pg_policies
WHERE tablename = 'submissions' AND schemaname = 'public';
```

---

## ðŸ“Š Mom vs Dad Game Schema (2026-01-08)

### Game Sessions Table

```sql
CREATE TABLE baby_shower.game_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_code VARCHAR(8) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'setup' CHECK (status IN ('setup', 'voting', 'revealed', 'complete')),
    mom_name VARCHAR(100) NOT NULL,
    dad_name VARCHAR(100) NOT NULL,
    admin_code VARCHAR(10) NOT NULL,
    total_rounds INTEGER DEFAULT 5,
    current_round INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_by VARCHAR,
    players JSONB DEFAULT '[]'::JSONB
);
```

**Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `session_code` | VARCHAR(8) | 6-8 character code for guests to join |
| `status` | VARCHAR(20) | setup/voting/revealed/complete |
| `mom_name` | VARCHAR(100) | Mom's name for personalized scenarios |
| `dad_name` | VARCHAR(100) | Dad's name for personalized scenarios |
| `admin_code` | VARCHAR(10) | 4-digit PIN for game admin |
| `total_rounds` | INTEGER | Number of rounds (default: 5) |
| `current_round` | INTEGER | Current round number |
| `players` | JSONB | Array of player objects |

---

### Game Players Table

```sql
CREATE TABLE baby_shower.game_players (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES baby_shower.game_sessions(id),
    player_name VARCHAR(100) NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    is_ready BOOLEAN DEFAULT FALSE,
    current_vote VARCHAR,
    joined_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### Game Scenarios Table

```sql
CREATE TABLE baby_shower.game_scenarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES baby_shower.game_sessions(id),
    round_number INTEGER NOT NULL,
    scenario_text TEXT NOT NULL,
    mom_option TEXT NOT NULL,
    dad_option TEXT NOT NULL,
    ai_provider VARCHAR DEFAULT 'z_ai',
    intensity NUMERIC DEFAULT 0.5,
    theme_tags TEXT[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    used_at TIMESTAMPTZ
);
```

---

### Game Votes Table

```sql
CREATE TABLE baby_shower.game_votes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID REFERENCES baby_shower.game_scenarios(id),
    guest_name VARCHAR(100) NOT NULL,
    guest_id UUID,
    vote_choice VARCHAR CHECK (vote_choice IN ('mom', 'dad')),
    voted_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### Game Results Table

```sql
CREATE TABLE baby_shower.game_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID REFERENCES baby_shower.game_scenarios(id),
    mom_votes INTEGER DEFAULT 0,
    dad_votes INTEGER DEFAULT 0,
    crowd_choice VARCHAR,
    actual_choice VARCHAR,
    perception_gap NUMERIC,
    roast_commentary TEXT,
    roast_provider VARCHAR DEFAULT 'moonshot',
    revealed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ðŸ”§ RPC Functions (2026-01-08)

### calculate_vote_stats

```sql
CREATE OR REPLACE FUNCTION baby_shower.calculate_vote_stats(p_scenario_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_result JSONB;
  v_mom_count INTEGER;
  v_dad_count INTEGER;
  v_total_votes INTEGER;
  v_mom_percentage NUMERIC;
  v_dad_percentage NUMERIC;
BEGIN
  SELECT COUNT(*) INTO v_mom_count
  FROM baby_shower.game_votes
  WHERE scenario_id = p_scenario_id AND vote_choice = 'mom';
  
  SELECT COUNT(*) INTO v_dad_count
  FROM baby_shower.game_votes
  WHERE scenario_id = p_scenario_id AND vote_choice = 'dad';
  
  v_total_votes := v_mom_count + v_dad_count;
  
  IF v_total_votes > 0 THEN
    v_mom_percentage := ROUND((v_mom_count::NUMERIC / v_total_votes::NUMERIC) * 100, 2);
    v_dad_percentage := ROUND((v_dad_count::NUMERIC / v_total_votes::NUMERIC) * 100, 2);
  ELSE
    v_mom_percentage := 0;
    v_dad_percentage := 0;
  END IF;
  
  v_result := jsonb_build_object(
    'scenario_id', p_scenario_id,
    'mom_count', v_mom_count,
    'dad_count', v_dad_count,
    'total_votes', v_total_votes,
    'mom_percentage', v_mom_percentage,
    'dad_percentage', v_dad_percentage
  );
  
  RETURN v_result;
END;
$$;

GRANT EXECUTE ON FUNCTION baby_shower.calculate_vote_stats(UUID) TO authenticated, anon;
```

---

**Document Version**: 1.1  
**Last Updated**: 2026-01-08  
**Changes:** Added Mom vs Dad game schema and RPC functions
