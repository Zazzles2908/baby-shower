# ðŸ” Database Schema Analysis & Documentation Discrepancies

**Date:** January 1, 2026  
**Analyzed By:** Senior Production Systems QA Analyst  
**Schema Source:** [`backend/supabase-schema.sql`](backend/supabase-schema.sql)  
**Documentation Compared:** [`ARCHITECTURE.md`](ARCHITECTURE.md), [`PLANS.md`](PLANS.md)

---

## ðŸ“‹ Executive Summary

Analyzed the Supabase database schema against project documentation. Found **5 critical discrepancies** that need to be addressed to maintain consistency between the database implementation and documentation.

**Critical Issues:**
1. Pool activity type mismatch between schema (line 30) and API (bug fix)
2. `pool_entries` view filters by wrong activity_type
3. Missing view documentation in ARCHITECTURE.md
4. Missing RLS policy details in documentation
5. Vote counts view schema needs verification

---

## ðŸ“Š Schema vs Documentation Comparison

### 1. Table Structure

| Aspect | Schema (SQL) | Documentation (ARCHITECTURE.md) | Status |
|--------|--------------|--------------------------------|--------|
| **Schema** | `baby_shower` | `baby_shower` | âœ… MATCH |
| **Table** | `baby_shower.submissions` | `baby_shower.submissions` | âœ… MATCH |
| **Primary Key** | `id bigint generated by default as identity` | Documented | âœ… MATCH |
| **Timestamps** | `created_at timestamp with time zone` | Documented | âœ… MATCH |
| **Name Field** | `name text not null` | Documented | âœ… MATCH |
| **Activity Type** | `activity_type text not null` | Documented | âœ… MATCH |
| **Activity Data** | `activity_data jsonb default '{}'::jsonb` | Documented | âœ… MATCH |

---

## ðŸš¨ Critical Discrepancies

### Discrepancy 1: Activity Type Value Mismatch

**Location:** [`backend/supabase-schema.sql:30-31`](backend/supabase-schema.sql:30)
```sql
-- Activity type: 'guestbook', 'pool', 'quiz', 'advice', 'voting'
activity_type text not null,
```

**Issue:** The schema documentation comment lists `'pool'` but our bug fix changed the API to send `'baby_pool'` to match client expectations.

**Current API Behavior (after bug fix):**
- [`api/pool.js:31`](api/pool.js:31) sends: `activity_type: 'baby_pool'`

**Impact:** 
- Schema says `'pool'`
- API sends `'baby_pool'`
- `pool_entries` view filters by `'pool'` â†’ **Will not work!**

**Required Fix in Schema:**
```sql
-- Activity type: 'guestbook', 'baby_pool', 'quiz', 'advice', 'voting'
-- Note: baby_pool (not pool) to match frontend client expectations
activity_type text not null,
```

---

### Discrepancy 2: pool_entries View Uses Wrong Activity Type

**Location:** [`backend/supabase-schema.sql:95-98`](backend/supabase-schema.sql:95)
```sql
create or replace view baby_shower.pool_entries as
select * from baby_shower.submissions 
where activity_type = 'pool'  -- âŒ WRONG! Should be 'baby_pool'
order by created_at desc;
```

**Issue:** View filters by `'pool'` but API sends `'baby_pool'`

**Required Fix:**
```sql
create or replace view baby_shower.pool_entries as
select * from baby_shower.submissions 
where activity_type = 'baby_pool'  -- âœ… CORRECT
order by created_at desc;
```

---

### Discrepancy 3: Missing Views in Documentation

**Location:** [`ARCHITECTURE.md`](ARCHITECTURE.md) - Views section

**Schema Defines These Views (lines 81-117):**
1. `baby_shower.submissions_count` - Activity counts
2. `baby_shower.guestbook_entries` - Guestbook filter
3. `baby_shower.pool_entries` - Pool filter (needs fix)
4. `baby_shower.quiz_entries` - Quiz filter
5. `baby_shower.advice_entries` - Advice filter
6. `baby_shower.vote_counts` - Vote aggregation

**ARCHITECTURE.md Documents:** Only mentions views exist, doesn't list them

**Required Update to ARCHITECTURE.md:**
```markdown
### **Helper Views**

The schema includes 6 helper views for common queries:

```sql
-- Activity counts by type
create or replace view baby_shower.submissions_count as
select activity_type, count(*) as total, 
       min(created_at) as first_submission,
       max(created_at) as last_submission
from baby_shower.submissions
group by activity_type;

-- Guestbook entries (activity_type = 'guestbook')
create or replace view baby_shower.guestbook_entries as
select * from baby_shower.submissions 
where activity_type = 'guestbook'
order by created_at desc;

-- Pool entries (activity_type = 'baby_pool')
create or replace view baby_shower.pool_entries as
select * from baby_shower.submissions 
where activity_type = 'baby_pool'
order by created_at desc;

-- Quiz entries (activity_type = 'quiz')
create or replace view baby_shower.quiz_entries as
select * from baby_shower.submissions 
where activity_type = 'quiz'
order by created_at desc;

-- Advice entries (activity_type = 'advice')
create or replace view baby_shower.advice_entries as
select * from baby_shower.submissions 
where activity_type = 'advice'
order by created_at desc;

-- Vote counts (parsed from activity_data.names array)
create or replace view baby_shower.vote_counts as
select 
    jsonb_array_elements_text(activity_data->'names') as baby_name,
    count(*) as vote_count
from baby_shower.submissions 
where activity_type = 'voting'
group by baby_name
order by vote_count desc;
```

**Note:** Views don't support Supabase Realtime - only the base table does.
```

---

### Discrepancy 4: RLS Policies Documentation

**Location:** [`ARCHITECTURE.md`](ARCHITECTURE.md) - Security section

**Schema Defines (lines 40-51):**
```sql
alter table baby_shower.submissions enable row level security;

create policy "Allow anonymous reads" on baby_shower.submissions
    for select using (true);

create policy "Allow anonymous inserts" on baby_shower.submissions
    for insert with check (true);
```

**ARCHITECTURE.md States:** "Supabase RLS policies prevent unauthorized access"

**Missing Details:**
- No specific policy documentation
- No mention of anonymous access for public app
- No mention of INSERT vs SELECT policies

**Required Update:**
```markdown
### **Row Level Security (RLS)**

The submissions table has RLS enabled with two policies:

1. **Anonymous Read Policy**
   ```sql
   create policy "Allow anonymous reads" on baby_shower.submissions
       for select using (true);
   ```
   - Allows anyone to read submissions
   - Required for viewing live stats

2. **Anonymous Insert Policy**
   ```sql
   create policy "Allow anonymous inserts" on baby_shower.submissions
       for insert with check (true);
   ```
   - Allows anyone to submit data
   - No authentication required (public event)
   - Client-side validation is primary protection

**Security Note:** RLS allows anonymous access intentionally for this public event app. The "security" comes from client-side validation and the ephemeral nature of the event.
```

---

### Discrepancy 5: Vote Counts View Schema

**Location:** [`backend/supabase-schema.sql:110-117`](backend/supabase-schema.sql:110)

**Schema Definition:**
```sql
create or replace view baby_shower.vote_counts as
select 
    jsonb_array_elements_text(activity_data->'names') as baby_name,
    count(*) as vote_count
from baby_shower.submissions 
where activity_type = 'voting'
group by baby_name
order by vote_count desc;
```

**Issue:** This view expects `activity_data.names` to be an array (which is correct after our bug fix!).

**API Now Sends (after bug fix):**
```javascript
// api/vote.js
activity_data: {
    names: selectedNames  // Array: ["Emma", "Olivia"]
}
```

**Status:** âœ… Vote counts view is correct for the fixed API

---

## ðŸ“‹ Complete Schema Reference

### Table Definition

```sql
-- Baby Shower App - Supabase Schema
create schema if not exists baby_shower;

create table if not exists baby_shower.submissions (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    name text not null,
    activity_type text not null,
    activity_data jsonb default '{}'::jsonb
);
```

### Activity Types

| activity_type | Description | Example activity_data |
|---------------|-------------|----------------------|
| `guestbook` | Wish messages | `{"relationship": "Friend", "message": "Congrats!"}` |
| `baby_pool` | Birth predictions | `{"date_guess": "2026-03-15", "time_guess": "14:30", "weight_guess": 3.4, "length_guess": 51}` |
| `quiz` | Quiz answers | `{"puzzle1": "Baby Shower", "puzzle2": "...", "score": 5}` |
| `advice` | Advice messages | `{"advice_type": "For Parents", "message": "Sleep when baby sleeps!"}` |
| `voting` | Name votes | `{"names": ["Emma", "Olivia", "Sophia"]}` |

### Indexes

```sql
create index idx_baby_shower_activity on baby_shower.submissions(activity_type);
create index idx_baby_shower_name on baby_shower.submissions(name);
create index idx_baby_shower_created on baby_shower.submissions(created_at desc);
```

### Permissions

```sql
-- Schema permissions
GRANT USAGE ON SCHEMA baby_shower TO anon, authenticated;

-- Table permissions
GRANT SELECT, INSERT ON baby_shower.submissions TO anon, authenticated;

-- View permissions
GRANT SELECT ON baby_shower.submissions_count TO anon, authenticated;
GRANT SELECT ON baby_shower.guestbook_entries TO anon, authenticated;
GRANT SELECT ON baby_shower.pool_entries TO anon, authenticated;
GRANT SELECT ON baby_shower.quiz_entries TO anon, authenticated;
GRANT SELECT ON baby_shower.advice_entries TO anon, authenticated;
GRANT SELECT ON baby_shower.vote_counts TO anon, authenticated;
```

---

## ðŸŽ¯ Required Actions

### Immediate (Before Event)

1. âœ… **FIX Schema Comments** - Update activity_type comment in [`backend/supabase-schema.sql:30`](backend/supabase-schema.sql:30)
   ```sql
   -- Activity type: 'guestbook', 'baby_pool', 'quiz', 'advice', 'voting'
   ```

2. âœ… **FIX pool_entries View** - Update [`backend/supabase-schema.sql:97`](backend/supabase-schema.sql:97)
   ```sql
   where activity_type = 'baby_pool'
   ```

3. âœ… **UPDATE ARCHITECTURE.md** - Add complete views documentation (see above)

4. âœ… **UPDATE ARCHITECTURE.md** - Add RLS policy documentation (see above)

---

## ðŸ“Š Summary of Changes Needed

| File | Change | Priority |
|------|--------|----------|
| `backend/supabase-schema.sql` | Fix comment on line 30 | P0 - Critical |
| `backend/supabase-schema.sql` | Fix pool_entries view on line 97 | P0 - Critical |
| `ARCHITECTURE.md` | Add complete views documentation | P1 - High |
| `ARCHITECTURE.md` | Add RLS policy details | P1 - High |
| `PLANS.md` | Note schema fix in status | P2 - Medium |

---

**Report Generated:** January 1, 2026  
**Next Review:** After schema fixes are applied  
**Status:** 5 discrepancies found, 2 critical (require schema fixes), 3 documentation (require updates)